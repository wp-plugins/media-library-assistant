(function(c){var e=wp.media,d={},a={},b=null;b=e.ajax;e.ajax=function(g,f){if(_.isObject(g)){f=g}else{f=f||{};f.data=_.extend(f.data||{},{action:g})}if("query-attachments"==f.data.action){stype=typeof f.data.query.s;if("object"==stype){s=f.data.query.s}else{if("string"==stype){s={mla_search_value:f.data.query.s}}else{s={}}}if("undefined"!=typeof s.mla_filter_month){a.filterMonth=s.mla_filter_month}if("undefined"!=typeof s.mla_filter_term){a.filterTerm=s.mla_filter_term}if("undefined"!=typeof s.mla_search_value){a.searchValue=s.mla_search_value}searchValues={mla_filter_month:a.filterMonth,mla_filter_term:a.filterTerm,mla_search_value:a.searchValue,mla_search_fields:a.searchFields,mla_search_connector:a.searchConnector};f.data.query.s=searchValues}return b.call(this,f)};d=typeof e.view.l10n.mla_strings==="undefined"?{}:e.view.l10n.mla_strings;a=typeof wp.media.view.settings.mla_settings==="undefined"?{}:wp.media.view.settings.mla_settings;if(a.enableMimeTypes){e.view.AttachmentFilters.Mla=e.view.AttachmentFilters.extend({createFilters:function(){var f={};_.each(a.mimeTypes||{},function(h,g){f[g]={text:h,props:{type:g,uploadedTo:null,orderby:"date",order:"DESC"}}});f.all={text:e.view.l10n.allMediaItems,props:{type:null,uploadedTo:null,orderby:"date",order:"DESC"},priority:10};f.uploaded={text:e.view.l10n.uploadedToThisPost,props:{type:null,uploadedTo:e.view.settings.post.id,orderby:"menuOrder",order:"ASC"},priority:20};this.filters=f}})}if(a.enableMonthsDropdown){e.view.AttachmentFilters.MlaMonths=e.view.AttachmentFilters.extend({className:"attachment-months",createFilters:function(){var f={};_.each(a.months||{},function(h,g){f[g]={text:h,props:{s:{mla_filter_month:g}}}});this.filters=f},select:function(){var f=this.model,h=a.filterMonth,g=f.toJSON();if(_.isUndefined(g.s)){g.s={}}if("string"==typeof g.search){a.searchValue=g.search}if(_.isUndefined(g.s.mla_filter_month)){g.s.mla_filter_month=a.filterMonth}else{a.filterMonth=g.s.mla_filter_month}_.find(this.filters,function(j,k){var i=_.all(j.props,function(m,l){return m.mla_filter_month==a.filterMonth});if(i){return h=k}});this.$el.val(h)}})}if(a.enableTermsDropdown){e.view.AttachmentFilters.MlaTerms=e.view.AttachmentFilters.extend({className:"attachment-terms",createFilters:function(){var f={};_.each(a.termsText||{},function(h,g){f[g]={text:h,props:{s:{mla_filter_term:parseInt(a.termsValue[g])}}}});this.filters=f},select:function(){var f=this.model,h=a.filterTerm,g=f.toJSON();if(_.isUndefined(g.s)){g.s={}}if("string"==typeof g.search){a.searchValue=g.search}if(_.isUndefined(g.s.mla_filter_term)){g.s.mla_filter_term=a.filterTerm}else{a.filterTerm=g.s.mla_filter_term}_.find(this.filters,function(j,k){var i=_.all(j.props,function(m,l){return m.mla_filter_term==a.filterTerm});if(i){return h=k}});this.$el.val(h)}})}if(a.enableSearchBox){e.view.MlaSearch=e.View.extend({tagName:"div",className:"mla-search-box",template:e.template("mla-search-box"),attributes:{type:"mla-search-box"},events:{change:"search",click:"search",search:"search",MlaSearch:"search"},render:function(){this.$el.html(this.template(d));return this},search:function(f){if(("click"==f.type)&&("mla_search_submit"!=f.target.name)){return}switch(f.target.name){case"s[mla_search_value]":a.searchValue=f.target.value;case"mla_search_submit":searchValues={mla_filter_month:a.filterMonth,mla_filter_term:a.filterTerm,mla_search_value:a.searchValue,mla_search_fields:a.searchFields,mla_search_connector:a.searchConnector};this.model.set({s:searchValues});break;case"s[mla_search_connector]":a.searchConnector=f.target.value;break;case"s[mla_search_title]":index=a.searchFields.indexOf("title");if(-1==index){a.searchFields.push("title")}else{a.searchFields.splice(index,1)}break;case"s[mla_search_name]":index=a.searchFields.indexOf("name");if(-1==index){a.searchFields.push("name")}else{a.searchFields.splice(index,1)}break;case"s[mla_search_alt_text]":index=a.searchFields.indexOf("alt-text");if(-1==index){a.searchFields.push("alt-text")}else{a.searchFields.splice(index,1)}break;case"s[mla_search_excerpt]":index=a.searchFields.indexOf("excerpt");if(-1==index){a.searchFields.push("excerpt")}else{a.searchFields.splice(index,1)}break;case"s[mla_search_content]":index=a.searchFields.indexOf("content");if(-1==index){a.searchFields.push("content")}else{a.searchFields.splice(index,1)}break}}})}if(a.enableMimeTypes||a.enableMonthsDropdown||a.enableTermsDropdown||a.enableSearchBox){wp.media.view.AttachmentsBrowser=wp.media.view.AttachmentsBrowser.extend({createToolbar:function(){var f;wp.media.view.AttachmentsBrowser.__super__.createToolbar.apply(this,arguments);f=this.options.filters;if(("all"===f)&&a.enableMimeTypes){this.toolbar.unset("filters",{silent:true});this.toolbar.set("filters",new e.view.AttachmentFilters.Mla({controller:this.controller,model:this.collection.props,priority:-80}).render())}if(f&&a.enableMonthsDropdown){this.toolbar.set("months",new e.view.AttachmentFilters.MlaMonths({controller:this.controller,model:this.collection.props,priority:-80}).render())}if(f&&a.enableTermsDropdown){this.toolbar.set("terms",new e.view.AttachmentFilters.MlaTerms({controller:this.controller,model:this.collection.props,priority:-80}).render())}if(this.options.search){if(a.enableSearchBox){this.toolbar.unset("search",{silent:true});this.toolbar.set("MlaSearch",new e.view.MlaSearch({controller:this.controller,model:this.collection.props,priority:60}).render())}}if(this.options.dragInfo){this.toolbar.set("dragInfo",new e.View({el:c('<div class="instructions">'+e.view.l10n.dragInfo+"</div>")[0],priority:-40}))}}})}}(jQuery));var mla={strings:{},settings:{},initialHTML:{},uploading:false,utility:{arrayCleanup:null,parseTaxonomyId:null,hookCompatTaxonomies:null,fillCompatTaxonomies:null,supportCompatTaxonomies:null},tagBox:null};(function(a){mla.strings=typeof wp.media.view.l10n.mla_strings==="undefined"?{}:wp.media.view.l10n.mla_strings;mla.settings=typeof wp.media.view.settings.mla_settings==="undefined"?{}:wp.media.view.settings.mla_settings;mla.utility.arrayCleanup=function(d){var c=[],b=("string"===typeof d);if(b){d=d.split(postL10n.comma)}jQuery.each(d,function(e,f){f=jQuery.trim(f);if(f&&jQuery.inArray(f,c)==-1){c.push(f)}});c.sort();if(b){c=c.join(postL10n.comma)}return c};mla.utility.parseTaxonomyId=function(c){var b=c.split("-");b.shift();b.shift();return b.join("-")};mla.tagBox={cleanTags:function(c){var b=postL10n.comma;if(","!==b){c=c.replace(new RegExp(b,"g"),",")}c=c.replace(/\s*,\s*/g,",").replace(/,+/g,",").replace(/[,\s]+$/,"").replace(/^[,\s]+/,"");if(","!==b){c=c.replace(/,/g,b)}return c},parseTags:function(e){var i=e.id,c=i.split("-check-num-")[1],f=a(e).closest(".tagsdiv"),h=f.find(".the-tags"),b=postL10n.comma,d=h.val().split(b),g=[];delete d[c];a.each(d,function(j,k){k=a.trim(k);if(k){g.push(k)}});h.val(this.cleanTags(g.join(b)));this.quickClicks(f);return false},quickClicks:function(d){var g=a(".the-tags",d),e=a(".tagchecklist",d),f=a(d).attr("id"),b,c;if(!g.length){return}c=g.prop("disabled");b=g.val().split(postL10n.comma);e.empty();a.each(b,function(i,k){var j,h;k=a.trim(k);if(!k){return}j=a("<span />").text(k);if(!c){h=a('<a id="'+f+"-check-num-"+i+'" class="ntdelbutton">X</a>');h.click(function(){mla.tagBox.parseTags(this)});j.prepend("&nbsp;").prepend(h)}e.append(j)})},flushTags:function(h,d,c){var j,b,e,k=a(".the-tags",h),g=a("input.newtag",h),i=postL10n.comma;d=d||false;e=d?a(d).text():g.val();j=k.val();b=j?j+i+e:e;b=mla.utility.arrayCleanup(this.cleanTags(b));k.val(b);this.quickClicks(h);if(!d){g.val("")}if("undefined"==typeof(c)){g.focus()}return false},getCloud:function(c,b){a.post(ajaxurl,{action:"get-tagcloud",tax:b},function(e,d){if(0===e||"success"!=d){e=wpAjax.broken}e=a('<p id="tagcloud-'+b+'" class="the-tagcloud">'+e+"</p>");a("a",e).click(function(){mla.tagBox.flushTags(a(this).closest(".mla-taxonomy-field").children(".tagsdiv"),this);return false});a("#"+c).after(e)})},init:function(f,b,d){var e,c;e=a("#mla-taxonomy-"+b,d);c=a("div.ajaxtag",e);mla.tagBox.quickClicks(e);a("input.tagadd",c).click(function(){mla.tagBox.flushTags(a(this).closest(".tagsdiv"))});a("input.newtag",c).keyup(function(g){if(13==g.which){mla.tagBox.flushTags(e);return false}}).keypress(function(g){if(13==g.which){g.preventDefault();return false}}).each(function(){a(this).suggest(ajaxurl+"?action=ajax-tag-search&tax="+b,{delay:500,resultsClass:"mla_ac_results",selectClass:"mla_ac_over",matchClass:"mla_ac_match",minchars:2,multiple:true,multipleSep:postL10n.comma+" "})});e.siblings(":first").click(function(){mla.tagBox.getCloud(a("a",this).attr("id"),b);a("a",this).unbind().click(function(){a(this).siblings(".the-tagcloud").toggle();return false});return false});a(".compat-field-"+b+" td",d).on("mouseleave",function(i){var k,h=this,g=mla.utility.arrayCleanup(a(".server-tags",h).val()),j=mla.utility.arrayCleanup(a(".the-tags",h).val());if(g===j){return}a(h).css("opacity","0.5");k={id:f,};k[b]=j;wp.media.post(mla.settings.ajaxUpdateCompatAction,k).done(function(m){var l,n;for(l in m){for(n in m[l]){a("#"+n,h).replaceWith(m[l][n])}}a(h).css("opacity","1.0")})});e.on("change",function(g){g.stopPropagation();return false});a(".the-tags, .server-tags .newtag",e).on("change",function(g){g.stopPropagation();return false})}};wp.media.view.AttachmentCompat=wp.media.view.AttachmentCompat.extend({initialize:function(){wp.media.view.AttachmentCompat.__super__.initialize.apply(this,arguments);this.on("ready",function(b){mla.utility.hookCompatTaxonomies(this.model.get("id"),this.el)})}});wp.media.model.Selection=wp.media.model.Selection.extend({initialize:function(){wp.media.model.Selection.__super__.initialize.apply(this,arguments);this.on("change:uploading",function(b){mla.uploading=true});this.on("change",function(b){if(mla.uploading){mla.utility.hookCompatTaxonomies(b.get("id"),wp.media.frame.$el);mla.uploading=false}})}});mla.utility.hookCompatTaxonomies=function(d,c){var b;if(mla.settings.enableDetailsCategory){a(".mla-taxonomy-field .categorydiv",c).each(function(){b=mla.utility.parseTaxonomyId(a(this).attr("id"));a(".compat-field-"+b+" th",c).click({id:d,currentTaxonomy:b,el:c},function(e){mla.utility.fillCompatTaxonomies(e.data)})})}if(mla.settings.enableDetailsTag){a(".mla-taxonomy-field .tagsdiv",c).each(function(){b=mla.utility.parseTaxonomyId(a(this).attr("id"));a(".compat-field-"+b+" th",c).click({id:d,currentTaxonomy:b,el:c},function(e){mla.utility.fillCompatTaxonomies(e.data)})})}};mla.utility.fillCompatTaxonomies=function(f){var c=f.el,e=[],b,d;if(mla.settings.enableDetailsCategory){a(".mla-taxonomy-field .categorydiv",c).each(function(){b=mla.utility.parseTaxonomyId(a(this).attr("id"));e[e.length]=b;d=".compat-field-"+b;if("undefined"===typeof(mla.initialHTML[b])){mla.initialHTML[b]=a(d,c).html()}else{a(d,c).html(mla.initialHTML[b])}a(d+" .categorydiv",c).html(mla.strings.loadingText)})}if(mla.settings.enableDetailsTag){a(".mla-taxonomy-field .tagsdiv",c).each(function(){b=mla.utility.parseTaxonomyId(a(this).attr("id"));e[e.length]=b;d=".compat-field-"+b;if("undefined"===typeof(mla.initialHTML[b])){mla.initialHTML[b]=a(d,c).html()}else{a(d,c).html(mla.initialHTML[b])}a(d+" .tagsdiv",c).html(mla.strings.loadingText)})}if(e.length){wp.media.post(mla.settings.ajaxFillCompatAction,{id:f.id,query:e,}).done(function(h){var g,i;for(g in h){i=".compat-field-"+g;a(i,c).html(h[g])}mla.utility.supportCompatTaxonomies(f);a(".compat-field-"+f.currentTaxonomy+" td",c).show()})}};mla.utility.supportCompatTaxonomies=function(d){var c=d.id,b=d.el;if(mla.settings.enableDetailsCategory){a(".mla-taxonomy-field .categorydiv",b).each(function(){var g=a(this),e,h,f,k,i,m,l,j;f=mla.utility.parseTaxonomyId(a(this).attr("id"));k=f+"_tab";i="#mla-"+f;m="#mla-new-"+f;l="#mla-search-"+f;j="#mla-attachments-"+c+"-"+f;if(f=="category"){k="cats"}g.find(".category-tabs").show();a(".compat-field-"+f+" th",b).click(function(){a(this).siblings("td").slideToggle()});g.on("mouseleave",function(p){var r,n,q=[],o=g.find(i+"-checklist input:checked");o.each(function(t){q[q.length]=a(this).val()});q.sort(function(u,t){return u-t});q=q.join(",");n=g.siblings(j).val();if(n===q){return}g.siblings(j).val(q);g.prop("disabled",true);r={id:c,};r[f]=q;wp.media.post(mla.settings.ajaxUpdateCompatAction,r).done(function(u){var t,v;for(t in u){for(v in u[t]){g.find("#"+v).html(u[t][v])}}g.find(l).val("");g.find(i+"-searcher").addClass("mla-hidden-children");g.prop("disabled",false)})});g.on('change input[type="checkbox"]',function(n){n.stopPropagation();return false});g.find(i+"-tabs a").click(function(){var n=a(this).attr("href");a(this).parent().addClass("tabs").siblings("li").removeClass("tabs");g.find(i+"-tabs").siblings(".tabs-panel").hide();g.find(n).show();a(this).focus();if("#mla-"+f+"-all"==n){deleteUserSetting(k)}else{setUserSetting(k,"pop")}return false});if(getUserSetting(k)){g.find(i+'-tabs a[href="#mla-'+f+'-pop"]').click()}g.find(i+"-add-toggle").click(function(){g.find(i+"-searcher").addClass("mla-hidden-children");g.find(i+"-adder").toggleClass("mla-hidden-children");g.find(i+'-tabs a[href="#mla-'+f+'-all"]').click();g.find(i+"-checklist li").show();g.find(i+"-checklist-pop li").show();if(false===g.find(i+"-adder").hasClass("mla-hidden-children")){g.find(m).val("").removeClass("form-input-tip");g.find(m).focus()}return false});g.find(m).keypress(function(n){if(13===n.keyCode){n.preventDefault();g.find(i+"-add-submit").click()}});g.find(i+"-add-submit").click(function(){g.find(m).focus()});e=function(n){if(!g.find(m).val()){return false}n.data+="&"+g.find(i+"-checklist :checked").serialize();g.prop("disabled",true);return n};h=function(q,p){var o,n=g.find(m+"_parent");g.prop("disabled",false);if("undefined"!=p.parsed.responses[0]&&(o=p.parsed.responses[0].supplemental.newcat_parent)){n.before(o);n.remove()}};g.find(i+"-checklist").wpList({alt:"",response:"mla-"+f+"-ajax-response",addBefore:e,addAfter:h});g.find(i+"-checklist, "+i+"-checklist-pop").on("click",'li.popular-category > label input[type="checkbox"]',function(){var n=a(this),p=n.is(":checked"),o=n.val();if(o&&n.parents("#mla-taxonomy-"+f).length){a("#in-"+f+"-"+o+", #in-popular-"+f+"-"+o).prop("checked",p)}});a.extend(a.expr[":"],{matchTerms:function(p,o,n,q){return(p.textContent||p.innerText||"").toLowerCase().indexOf((n[3]||"").toLowerCase())>=0}});g.find(l).keypress(function(n){if(13===n.keyCode){n.preventDefault();g.find(l).val("");g.find(i+"-searcher").addClass("mla-hidden-children");g.find(i+"-checklist li").show();g.find(i+"-checklist-pop li").show();return}});g.find(l).keyup(function(p){var q,o,n;if(13===p.keyCode){p.preventDefault();g.find(i+"-search-toggle").focus();return}q=g.find(l).val(),termList=g.find(i+"-checklist li");termListPopular=g.find(i+"-checklist-pop li");if(0<q.length){termList.hide();termListPopular.hide()}else{termList.show();termListPopular.show()}o=g.find(i+"-checklist label:matchTerms('"+q+"')");o.closest("li").find("li").andSelf().show();o.parents(i+"-checklist li").show();n=g.find(i+"-checklist-pop label:matchTerms('"+q+"')");n.closest("li").find("li").andSelf().show();n.parents(i+"-checklist li").show()});g.find(i+"-search-toggle").click(function(){g.find(i+"-adder ").addClass("mla-hidden-children");g.find(i+"-searcher").toggleClass("mla-hidden-children");g.find(i+'-tabs a[href="#mla-'+f+'-all"]').click();g.find(i+"-checklist li").show();g.find(i+"-checklist-pop li").show();if(false===g.find(i+"-searcher").hasClass("mla-hidden-children")){g.find(l).val("").removeClass("form-input-tip");g.find(l).focus()}return false})})}if(mla.settings.enableDetailsTag){a(".mla-taxonomy-field .tagsdiv",b).each(function(){var e=mla.utility.parseTaxonomyId(a(this).attr("id"));a(".compat-field-"+e+" th",b).click(function(){a(this).siblings("td").slideToggle()});mla.tagBox.init(c,e,b)})}}}(jQuery));